<html>
    <head>
        <title>Home Pro</title>
        <script src="assets/jquery-3.6.0.min.js"></script>

        <!-- <script src="assets/jquery-ui.min.js"></script> -->
        <script src="assets/jquery-ui.js"></script>
        <link rel="stylesheet" href="assets/jquery-ui.theme.min.css">

        <script src="assets/controller.js"></script>
        <link rel="stylesheet" href="assets/styles/default/style.css">
        <link rel="icon" type="image/png" href="assets/favicon.png">
        <script>
            $(document).ready(()=>{
                $("#editShort input[name='type']").change(()=>{
                    // console.log("asd"); 
                    // $("#editShort input[name='type'][value='group']").attr('checked', true);
                    console.log(this);
                    var val=$("#editShort input[name='type']:checked").val();
                    if(val=="uri"){
                        $("#editShort #link").parent().parent().show(1);
                        $("#editShort #newtab").parent().parent().show(1);
                        $("#editShort #icon").parent().parent().show(1);
                    }else{
                        $("#editShort #link").parent().parent().hide(1);
                        $("#editShort #newtab").parent().parent().hide(1);
                        $("#editShort #icon").parent().parent().hide(1);
                        // $("#editShort #name").val("New group");
                    }
                });
            });
            function editMode(){
                linkDraggable(".linkDraggable", $("#shortcuts"));
                linksContainerDroppable("#shortcuts");
                groupDroppable(".uriGroup");
                // mergeLinks(".linkDraggable");
            }
            function stopEditMode(){
                $(".linkDraggable").draggable("destroy")
                $("#shortcuts").droppable("destroy");
                $(".uriGroup").droppable("destroy");
            }

            // LINKS
            function linkDraggable(elementSelector, containerElement){
                $( elementSelector, containerElement ).draggable({
                    // cancel: "a.ui-icon", // clicking an icon won't initiate dragging
                    revert: false, // when not dropped, the item will revert back to its initial position
                    containment: "document",
                    helper: "clone",
                    cursor: "move",
                });
            }

            // REMOVE LINK FROM GROUP
            function linksContainerDroppable(elementSelector){
                $(elementSelector).droppable({
                    accept: ".uriGroup .container > .linkDraggable",
                    classes: {
                        "ui-droppable-active": "ui-state-highlight"
                    },
                    drop: async function( event, ui ) {
                        var origin=$(ui.draggable[0]).parent().parent()[0];
                        var target=event.target;
                        var elementCopy=ui.draggable[0];

                        $.ajax({
                            url:"/shortcuts/removeFromGroup",
                            timeout: 666,
                            data:{
                                element:elementCopy.id,
                                group:origin.id
                            },
                            success:(response)=>{
                                if(response=="saved"){
                                    alert("saved");
                                    // $(target).children(".container").append(elementCopy);
                                    $(event.target).children(".container").append(elementCopy);
                                    if($(origin).find(".container").children().length==0){
                                        if(confirm("delete empty group?")){
                                            document.getElementById("#sndFX-pop").play();
                                            $(origin).remove();
                                            // $(origin).droppable( "destroy" );
                                        }
                                    }
                                }else{
                                    alert("couldn't save\n"+response);
                                }
                            }
                        }).fail((jqXHR, textStatus, errorThrown)=>{
                            alert("couldn't save\n"+textStatus);
                        });






                    }
                });
            }
            // ADD LINK TO GROUP
            function groupDroppable(elementSelector){
                $(elementSelector).droppable({
                    tolerance:"pointer",
                    accept: "#shortcuts .container > .linkDraggable",
                    classes: {
                        "ui-droppable-active": "ui-state-highlight"
                    },
                    drop: async function( event, ui ) {
                        var origin=$(ui.draggable[0]).parent().parent()[0];
                        var target=event.target;
                        var elementCopy=ui.draggable[0];
                        
                        $.ajax({
                            url:"/shortcuts/addToGroup",
                            timeout: 666,
                            data:{
                                element:elementCopy.id,
                                group:target.id
                            },
                            success:(response)=>{
                                if(response=="saved"){
                                    alert("saved");
                                    $(target).children(".container").append(elementCopy);
                                }else{
                                    alert("couldn't save");
                                }
                            }
                        }).fail((jqXHR, textStatus, errorThrown)=>{
                            alert("couldn't save\n"+textStatus);
                        });
                    }
                });
            }
            //MERGE LINKS TO CREATE GROUP
            //TESTING
            /*
            async function mergeLinks(selector){
                $(selector).droppable({
                    tolerance:"pointer",
                    accept: "#shortcuts .container > .elementContainer",
                    classes: {
                        "ui-droppable-active": "ui-state-highlight"
                    },
                    drop: async function( event, ui ) {
                        // var origin=$(ui.draggable[0]).parent().parent()[0];
                        var target=event.target;
                        var elementCopy=ui.draggable[0];

                        
                        console.log("merge");
                        // console.log(origin, target, elementCopy);

                        var newId=idGenerator();
                        await $("#shortcuts > .container").append(`<div class="element uriGroup" id=${newId} type="group">
                            <div class="bgBlur"></div>
                            <div class="imgContainer">
                                <img src="/assets/styles/default/IMG" onerror="this.onerror=null;this.src='assets/styles/default/noIcon.png';">
                            </div>
                            <span class="text-shadow">New Group</span>
                            <div class="container">`);
                        await groupDroppable("#"+newId);
                        $(target).droppable("disable");
                        $(elementCopy).droppable("disable");
                        $("#"+newId+" .container").append(target,elementCopy);
                    }
                });
            }
            */
        </script>
    </head>
    <body>
        <audio id="#sndFX-pop" src="/assets/styles/default/audio/QKTA234-pop.mp3" preload="auto"></audio>
        <div id="background"></div>
        <nav>
            <div>
                <ul class="menu2">
                    <a class="txt-shadow" href="#shortcuts"><li>Shortcuts</li></a>
                    <a class="txt-shadow" href="#localhost"><li>Localhost</li></a>
                </ul>
            </div>
            <div>
                <form action="<%-defaultSearch%>=" class="searchForm" id="searchForm" onsubmit="validateSearch()">
                    <input id="searchInput" type="text" value="" place holder="Search"
                        name="q" autofocus onkeyup="testApi();" class="txt-shadow"
                        autocomplete="ñÑñÑ" tabindex="1" >
                    <input id="searchBtn" type="submit" value="Go!" onclick='event.preventDefault();validateSearch();'>
                    <label for="searchBtn" style="background: var(--background);" tabindex="1">
                        <img src="<%-defaultSearchImg%>" alt="Search" height="20" style="margin:5px;">
                    </label>
                    <ul id="searchEngines" class="engines" tabindex="2">
                        <div class="desp noselect" style="pointer-events: none;">▼</div>
                        <div style="margin-top: 22px;width: 0px;height: 0px;" class="noselect">
                            <%-engines%>
                        </div>
                    </ul>
                </form>
            </div>
        </nav>
        <section id="shortcuts">
            <h5 class="txt-shadow">Shortcuts</h5>
            <div><button onclick="editMode()">edit</button></div>
            <div><button onclick="stopEditMode()()">done</button></div>
            <div class="container">
                <!-- ADD SHORTCUT -->
                <div class="elementContainer" id="addNew">
                    <a class="element uri"
                    onclick="edit(this.parentElement,'new')">
                        <div class="bgBlur"></div>
                        <div class="imgContainer">
                            <p style="width: 48px;
                            height: 48px;"
                            >
                            ➕
                            </p>
                        </div>
                        <span class="txt-shadow">Add</span>
                    </a>
                </div>
                <!-- ADD SHORTCUT (END) -->
                <%-shortcuts%>

            </div>
        </section>
        <section id="localhost">
            <% if(filesFound!="" || folders!=""){ %>
            <h5 class="txt-shadow">Localhost</h5>
            <%
                }
            %>

            <div class="container">
                <%-filesFound%>
            </div>
        </section>
        <section>
            <div class="container">
                <%-folders%>
            </div>
        </section>

        <div id="testClick" style="
            display: block;
            position: fixed;
            top: 0px;
            left: 0px;
            width: 2px;
            height: 2px;
            background: transparent;
            z-index: 9999999;
            pointer-events: none;
        "></div>
<script>
    function newShortcut(){
        // saber si es un enlace valido
        // ^((https|ftp|http):\/\/)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)
        // ^((https|ftp|http):\/\/)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}
        // Quitar prefijos
        // ^((https|ftp|http):\/\/)?(www\.)?
        // showEdit();

        // no admite puntos juntos
        //funciona mejor
        // ^((https|ftp|http):\/\/)?(www\.)?[-a-zA-Z0-9@:%_\+~#=]{1,256}(\.{1})[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)

        // obtener solo nombre del dominio intento 1
        // (?<=((https|ftp|http):\/\/)).*(?=\.[a-zA-Z]{1,6})

        //quitar protocolo y asi
        // ((https|ftp|http):\/\/)(www.)?
        //quitar dominio
        // ((\.{1})[a-zA-Z0-9()]{1,6}){1}\b
    }

    async function autocompleteShortcut(value){
        if(
			value.match(/^((https|ftp|http|tel):\/\/)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/)
			||
			value.match(/^mailto:(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)
		){
            var name=await value.replace(/((https|ftp|http):\/\/)(www.)?/,'').replace(/((\.{1})[a-zA-Z0-9()]{1,6}){1}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/,'');

            if(name!=""){
                $("#editShort #name").val(name);
                $("#editShort #shortcutID").val(name);
            }
            // get favicon
            //^((https|ftp|http):\/\/)?(www\.)?[-a-zA-Z0-9@:%_\+~#=]{1,256}((\.{1})[a-zA-Z0-9()]{1,6}){1,}
            /// ^((https|ftp|http):\/\/)?(www\.)?[-a-zA-Z0-9@:%_\+~#=]{1,256}((\.{1})[a-zA-Z0-9()]{1,6}){1,}
            /*
            var x=$("#link").val();
            x.match(/^((https|ftp|http):\/\/)?(www\.)?[-a-zA-Z0-9@:%_\+~#=]{1,256}((\.{1})[a-zA-Z0-9()]{1,6}){1,}/)[0]
            */
            var favicon=value.match(/^((https|ftp|http):\/\/)?(www\.)?[-a-zA-Z0-9@:%_\+~#=]{1,256}((\.{1})[a-zA-Z0-9()]{1,6}){1,}/)[0]+"/favicon.ico";
            console.log(favicon);
            $("#editShort #sctIcon").attr("src",favicon);
            $("#editShort #icon").val(favicon);
            /*
            //get favicon
            // (?=<link)(.*)(rel="shortcut icon")(.*)>
            */
        }
    }
    function edit(element,mode){
        showEdit();

        $("#mode").val(mode);
        if(mode=="new"){
            $("#shortcutID").val(idGenerator());
            
        }else{
            // $("#link").parent().parent().show(1);
            // $("#newtab").parent().parent().show(1);
        }
    }
    function cancelEdit(){
        $("#editLink").fadeOut(333);
        setTimeout(() => {
            $("#editShort")[0].reset();
        }, 334);
    }
    function shortcutsRead(element){
        $.ajax({
            url:"/shortcuts/read",
            data:{
                shortcutID:element.id
            },
            success:function(response){
                $("#editShort #type").val(element.attributes.type.value);
                $("#editShort #link").val(response.uri);
                $("#editShort #name").val(response.name);
                $("#editShort #icon").val(response.icon);
                $("#editShort #shortcutID").val(element.id);
                $("#editShort #newtab").prop("checked",response.blank);
            }
        });
    }
    function shortcutsSave(){
        var data={
                shortcutID:$("#shortcutID").val(),
                name:$("#name").val(),
                icon:$("#icon").val(),
                newtab:$("#newtab").prop("checked"),
                link:$("#link").val()
            };
        $.ajax({
            url:"/shortcuts/save",
            data,
            success:function(response){
                $("#"+data.shortcutID+" .txt-shadow").text(data.name);
            }
        });
    }
</script>
<div id="editLink">
    <div style="background-color: transparent;width: 100%;height: 100%;"></div>
    <form id="editShort">
        <table>
            <tr>
                <td><label class="txt-shadow" for="type">type</label></td>
                <td>
                    <!-- <select name="type" id="type">
                        <option value="uri">link</option>
                        <option value="group">group</option>
                    </select> -->
                    <label for="uri">Link</label>
                    <input type="radio" id="uri" value="uri" name="type">
                    <label for="group">Group</label>
                    <input type="radio" id="group" value="group" name="type">
                </td>
            <tr class="hidden">
                <td><label class="txt-shadow" for="mode">mode</label></td>
                <td><input id="mode" name="mode" type="text" value=""></td>
            </tr>
            <tr class="hidden">
                <td><label class="txt-shadow" for="shortcutID">ID</label></td>
                <td><input id="shortcutID" name="shortcutID" type=""></td>
            </tr>
            <tr>
                <td><label class="txt-shadow" for="link">link</label></td>
                <td>
                    <textarea name="link" id="link" style="width:100%" rows="4"
                    ></textarea>
                </td>
            </tr>
            <tr>
                <td><label class="txt-shadow" for="name">Name</label></td>
                <td><input id="name" name="name" type=""></td>
            </tr>
            <tr>
                <td><label class="txt-shadow" for="icon">icon</label></td>
                <td><img id="sctIcon" width="24" height="24" src=""><input id="icon" name="icon" type=""></td>
            </tr>
            <tr>
                <td><label class="txt-shadow" for="newtab">New tab</label></td>
                <td><input id="newtab" name="newtab" type="checkbox"></td>
            </tr>
            <tr>
                <td colspan="2" style="
                    display: inline-flex;
                ">
                    <input type="button" value="Save" onclick='shortcutsSave()'>
                    <input type="reset" value="Cancel" onclick='cancelEdit();'>
                </td>
            </tr>
        </table>
    </form>
</div>
<div id="mdl-conf">
    <table>
        <tr>
            <td>Theme</td>
        </tr>
    </table>
</div>

    </body>
    <footer class="credits txt-shadow">
        <span
        onclick=""
        >⚙</span>
        <a href="https://twitter.com/a_non34">Contact</a>
    </footer>
</html>